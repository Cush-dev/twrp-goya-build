name: Build TWRP for Xiaomi 15T (goya)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Clean up space
      run: |
        echo "üßπ Cleaning up disk space..."
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        sudo apt clean
        df -h
        echo "‚úÖ Clean complete."

    - name: Install dependencies
      run: |
        sudo apt update && sudo apt install -y \
          git-core gnupg flex bison gperf build-essential zip curl zlib1g-dev \
          gcc-multilib g++-multilib lib32ncurses5-dev x11proto-core-dev \
          libx11-dev lib32z1-dev ccache libgl1-mesa-dev libxml2-utils xsltproc unzip python3

    - name: Install repo tool
      run: |
        echo "üì¶ Installing repo..."
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        export PATH="$HOME/bin:$PATH"
        echo "‚úÖ Repo installed at: $(which repo)"
        repo --version || echo "‚ö†Ô∏è Repo version check failed but continuing..."

    - name: Initialize TWRP source
      run: |
        export PATH="$HOME/bin:$PATH"
        mkdir -p ~/android/twrp
        cd ~/android/twrp
        ~/bin/repo init -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git -b twrp-12.1
        ~/bin/repo sync -j$(nproc)

    - name: Clone device tree
      run: |
        cd ~/android/twrp
        git clone https://github.com/${{ github.repository_owner }}/twrp-goya-device.git device/xiaomi/goya

    - name: Build recovery
      run: |
        export PATH="$HOME/bin:$PATH"
        cd ~/android/twrp
        source build/envsetup.sh
        lunch omni_goya-eng
        mka recoveryimage -j$(nproc)

    - name: Upload compiled recovery
      uses: actions/upload-artifact@v4
      with:
        name: twrp-goya-build
        path: out/target/product/goya/recovery.img

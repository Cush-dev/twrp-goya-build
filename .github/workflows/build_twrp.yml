name: Build TWRP for Xiaomi 15T (goya)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install build dependencies
      run: |
        sudo apt update && sudo apt install -y git-core gnupg flex bison build-essential \
        zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 \
        lib32z1-dev libxml2-utils xsltproc unzip python3 openjdk-11-jdk bc ccache lz4 lzip

    - name: Initialize TWRP source
      run: |
        mkdir -p ~/android/twrp
        cd ~/android/twrp
        repo init -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git -b twrp-12.1
        repo sync -j$(nproc)
        mkdir -p device/xiaomi
        cp -r $GITHUB_WORKSPACE/device/xiaomi/goya device/xiaomi/

    - name: Build TWRP
      run: |
        cd ~/android/twrp
        . build/envsetup.sh
        lunch twrp_goya-eng
        mka vendorbootimage
        mkdir -p $GITHUB_WORKSPACE/output
        cp out/target/product/goya/vendor_boot.img $GITHUB_WORKSPACE/output/ || true
        cp out/target/product/goya/recovery.img $GITHUB_WORKSPACE/output/ || true

    - name: Upload compiled images
      uses: actions/upload-artifact@v3
      with:
        name: twrp-goya-build
        path: output/
